@using DataHub.Core.Services.Generic
@using DataHub.Core.Models.Interfaces
@using DataHub.Core.Services
@using DataHub.Core.Models
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using DataHub.Core.Interfaces
@using Microsoft.Extensions.Logging

@typeparam TItem where TItem : class, ICloneable, IAuditableEntity

@inject NavigationManager NavigationManager
@inject NavigationContextService NavContext
@inject ChangeSetService ChangeSetService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject ILogger<GenericEntityActionPage<TItem>> Logger
@inject IJSRuntime JSRuntime

<div class="entity-action-page" @onkeydown="HandleKeyDown">
    
    @* Header Section *@
    <FluentStack Orientation="Orientation.Vertical" Class="page-header mb-4">
        <FluentStack Orientation="Orientation.Horizontal" Class="header-title-row">
            <h2 class="page-title">@Title</h2>
            <FluentBadge Appearance="@GetModeBadgeAppearance()" Class="mode-badge">@GetModeText()</FluentBadge>
        </FluentStack>
        
        @if (_isNavigating)
        {
            <FluentStack Orientation="Orientation.Horizontal" HorizontalAlignment="HorizontalAlignment.Center" Class="record-counter">
                <span class="counter-text">Record @(_currentIndex + 1) of @_totalCount</span>
            </FluentStack>
        }
    </FluentStack>

    @if (item == null && !isLoading)
    {
        <FluentCard Class="error-card">
            <FluentStack Orientation="Orientation.Vertical" VerticalGap="12">
                <span style="color: var(--error-foreground-rest); font-size: 2rem;">‚ö†Ô∏è</span>
                <p class="error-message">Item with ID @Id not found.</p>
                <FluentButton Appearance="Appearance.Neutral" OnClick="NavigateBack">Back to List</FluentButton>
            </FluentStack>
        </FluentCard>
    }
    else if (isLoading)
    {
        <FluentCard Class="loading-card">
            <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="12" HorizontalAlignment="HorizontalAlignment.Center">
                <FluentProgressRing />
                <p>Loading...</p>
            </FluentStack>
        </FluentCard>
    }
    else if (item != null)
    {
        <FluentCard Class="form-card">
            <EditForm Model="@item" OnValidSubmit="HandleFormSubmit">
                <DataAnnotationsValidator />
                
                @* Validation Summary *@
                <div class="validation-section mb-3">
                    <ValidationSummary />
                </div>

                @* Form Fields Section *@
                <FluentStack Orientation="Orientation.Vertical" Class="form-fields-section mb-4">
                    <fieldset disabled="@isReadOnly" class="form-fieldset">
                        <div class="form-grid">
                            @EditorTemplate(item)
                        </div>
                    </fieldset>
                </FluentStack>

                @* Primary Actions *@
                <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="8" Class="primary-actions mb-3">
                    @if (NavContext.Mode == RecordInteractionMode.Edit)
                    {
                        <FluentButton Type="ButtonType.Submit" Appearance="Appearance.Accent">
                            üíæ Save
                        </FluentButton>
                    }
                    @if (NavContext.Mode == RecordInteractionMode.Copy)
                    {
                        <FluentButton Type="ButtonType.Button" Appearance="Appearance.Accent" OnClick="HandleCopy">
                            üìã Copy
                        </FluentButton>
                    }
                    @if (NavContext.Mode == RecordInteractionMode.Delete)
                    {
                        <FluentButton Type="ButtonType.Button" Appearance="Appearance.Accent" OnClick="HandleDelete">
                            üóëÔ∏è Delete
                        </FluentButton>
                    }
                    <FluentButton Type="ButtonType.Button" Appearance="Appearance.Neutral" OnClick="Cancel">
                        Cancel
                    </FluentButton>
                </FluentStack>

                @* Batch Actions Section *@
                @if (_isNavigating)
                {
                    <FluentDivider Class="my-3" />
                    
                    <FluentStack Orientation="Orientation.Vertical" VerticalGap="12" Class="batch-actions-section">
                        <h4 class="section-title">Batch Operations</h4>
                        
                        <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="8">
                            @if (NavContext.Mode == RecordInteractionMode.Edit)
                            {
                                <FluentButton Appearance="Appearance.Accent" OnClick="HandleSaveAll" Disabled="!_hasPendingChanges">
                                    üíæ Save All (@_pendingChangesCount)
                                </FluentButton>
                                <FluentButton Appearance="Appearance.Neutral" OnClick="HandleCancelAll" Disabled="!_hasPendingChanges">
                                    Cancel All
                                </FluentButton>
                            }
                            @if (NavContext.Mode == RecordInteractionMode.Copy)
                            {
                                <FluentButton Appearance="Appearance.Accent" OnClick="HandleCopyAll">
                                    üìã Copy All (@NavContext.NavigableRecordIds.Count)
                                </FluentButton>
                            }
                            @if (NavContext.Mode == RecordInteractionMode.Delete)
                            {
                                <FluentButton Appearance="Appearance.Accent" OnClick="HandleDeleteAll">
                                    üóëÔ∏è Delete All (@NavContext.NavigableRecordIds.Count)
                                </FluentButton>
                            }
                        </FluentStack>
                    </FluentStack>
                }
            </EditForm>
        </FluentCard>

        @* Navigation Controls *@
        @if (_isNavigating)
        {
            <FluentCard Class="navigation-card mt-3">
                <FluentStack Orientation="Orientation.Vertical" VerticalGap="12">
                    <FluentStack Orientation="Orientation.Horizontal" HorizontalAlignment="HorizontalAlignment.Start">
                        <span class="nav-hint">Keyboard: PageUp / PageDown</span>
                        <span class="nav-position">@(_currentIndex + 1) / @_totalCount</span>
                    </FluentStack>
                    
                    <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="8" HorizontalAlignment="HorizontalAlignment.Center" Wrap="true">
                        <FluentButton OnClick="NavigateToFirst" Disabled="!_canNavigatePrevious">
                            ‚èÆÔ∏è First
                        </FluentButton>
                        <FluentButton OnClick="NavigateToPrevious" Disabled="!_canNavigatePrevious">
                            ‚óÄÔ∏è Previous
                        </FluentButton>
                        <FluentButton OnClick="NavigateToNext" Disabled="!_canNavigateNext">
                            Next ‚ñ∂Ô∏è
                        </FluentButton>
                        <FluentButton OnClick="NavigateToLast" Disabled="!_canNavigateNext">
                            Last ‚è≠Ô∏è
                        </FluentButton>
                    </FluentStack>
                </FluentStack>
            </FluentCard>
        }
    }
</div>

@code {
    [Parameter]
    public int? Id { get; set; }

    [Parameter]
    public IDataService<TItem> DataService { get; set; } = default!;

    [Parameter]
    public RenderFragment<TItem> EditorTemplate { get; set; } = default!;

    [Parameter]
    public string EntityName { get; set; } = "Item";

    [Parameter]
    public string ListPagePath { get; set; } = "/";

    private TItem item = default!;
    private bool isLoading = true;
    private bool isReadOnly = false;
    private string _userId = "";

    private bool _isNavigating => NavContext.NavigableRecordIds.Count > 1;
    private bool _canNavigatePrevious => _currentIndex > 0;
    private bool _canNavigateNext => _currentIndex < _totalCount - 1;
    private int _currentIndex = -1;
    private int _totalCount = 0;

    private bool _hasPendingChanges => ChangeSetService.GetChangeSetForUser(_userId).HasChanges;
    private int _pendingChangesCount => ChangeSetService.GetChangeSetForUser(_userId).UpdatedItems.Count + ChangeSetService.GetChangeSetForUser(_userId).ItemsToDelete.Count;

    private bool isNew = false;

    private string Title
    {
        get
        {
            if (isNew) return $"New {EntityName}";
            return NavContext.Mode switch
            {
                RecordInteractionMode.Edit => $"Edit {EntityName}",
                RecordInteractionMode.View => $"View {EntityName}",
                RecordInteractionMode.Copy => $"Copy {EntityName}",
                RecordInteractionMode.Delete => $"Delete {EntityName}",
                _ => EntityName
            };
        }
    }

    private Appearance GetModeBadgeAppearance()
    {
        return NavContext.Mode switch
        {
            RecordInteractionMode.Edit => Appearance.Accent,
            RecordInteractionMode.Delete => Appearance.Lightweight,
            RecordInteractionMode.Copy => Appearance.Neutral,
            _ => Appearance.Neutral
        };
    }

    private string GetModeText()
    {
        if (isNew) return "NEW";
        return NavContext.Mode.ToString().ToUpper();
    }

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;
        isNew = Id == null || Id == 0;
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        _userId = authState.User.FindFirstValue(ClaimTypes.NameIdentifier) ?? "SYSTEM";

        isReadOnly = NavContext.Mode == RecordInteractionMode.View || NavContext.Mode == RecordInteractionMode.Delete;

        if (_isNavigating)
        {
            _totalCount = NavContext.NavigableRecordIds.Count;
            _currentIndex = NavContext.NavigableRecordIds.IndexOf(Id.Value);
        }

        var changeSet = ChangeSetService.GetChangeSetForUser(_userId);
        if (Id.HasValue && changeSet.UpdatedItems.TryGetValue(Id.Value, out var changedItemObject))
        {
            item = (TItem)changedItemObject;
        }
        else if (!isNew)
        {
            var originalItem = await DataService.GetByIdAsync(Id.Value);
            if (originalItem != null)
            {
                item = (TItem)originalItem.Clone();
            }
        }
        else
        {
            item = Activator.CreateInstance<TItem>();
        }

        isLoading = false;
    }

    private async Task HandleFormSubmit()
    {
        var changeSet = ChangeSetService.GetChangeSetForUser(_userId);
        changeSet.AddOrUpdateItem(item.Id, item);
        Logger.LogInformation("Item {Id} saved to changeset.", item.Id);
        if (!_isNavigating)
        {
            await HandleSaveAll();
        }
    }

    private void Cancel()
    {
        if (Id.HasValue) {
            ChangeSetService.GetChangeSetForUser(_userId).RemoveFromChangeSet(Id.Value);
        }
        NavigateBack();
    }

    private void NavigateBack()
    {
        NavContext.ClearNavigationContext();
        NavigationManager.NavigateTo(ListPagePath);
    }

    private void HandleKeyDown(KeyboardEventArgs e)
    {
        if (_isNavigating)
        {
            if (e.Key == "PageDown") NavigateToNext();
            if (e.Key == "PageUp") NavigateToPrevious();
        }
    }

    private void NavigateToFirst()
    {
        if (_isNavigating)
        {
            var firstId = NavContext.NavigableRecordIds[0];
            NavigationManager.NavigateTo($"{NavContext.BasePath}/{firstId}", forceLoad: true);
        }
    }

    private void NavigateToLast()
    {
        if (_isNavigating)
        {
            var lastId = NavContext.NavigableRecordIds[^1];
            NavigationManager.NavigateTo($"{NavContext.BasePath}/{lastId}", forceLoad: true);
        }
    }

    private void NavigateToNext()
    {
        if (_canNavigateNext)
        {
            var nextId = NavContext.NavigableRecordIds[_currentIndex + 1];
            NavigationManager.NavigateTo($"{NavContext.BasePath}/{nextId}", forceLoad: true);
        }
    }

    private void NavigateToPrevious()
    {
        if (_canNavigatePrevious)
        {
            var prevId = NavContext.NavigableRecordIds[_currentIndex - 1];
            NavigationManager.NavigateTo($"{NavContext.BasePath}/{prevId}", forceLoad: true);
        }
    }

    private async Task HandleDelete()
    {
        if (item == null) return;
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", $"Are you sure you want to delete this item?");
        if (confirmed)
        {
            await DataService.DeleteAsync(item.Id);
            NavigateBack();
        }
    }

    private async Task HandleDeleteAll()
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", $"Are you sure you want to delete all {NavContext.NavigableRecordIds.Count} selected items?");
        if (confirmed)
        {
            foreach (var id in NavContext.NavigableRecordIds)
            {
                await DataService.DeleteAsync((int)id);
            }
            NavigateBack();
        }
    }

    private async Task HandleCopy()
    {
        if (item == null) return;
        item.Id = 0;
        await DataService.AddAsync(item);
        NavigateBack();
    }

    private async Task HandleCopyAll()
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", $"Are you sure you want to copy all {NavContext.NavigableRecordIds.Count} selected items?");
        if (confirmed)
        {
            foreach (var id in NavContext.NavigableRecordIds)
            {
                var originalItem = await DataService.GetByIdAsync((int)id);
                if (originalItem != null)
                {
                    var newItem = (TItem)originalItem.Clone();
                    newItem.Id = 0;
                    await DataService.AddAsync(newItem);
                }
            }
            NavigateBack();
        }
    }

    private async Task HandleSaveAll()
    {
        var changeSet = ChangeSetService.GetChangeSetForUser(_userId);
        foreach (var itemObject in changeSet.UpdatedItems.Values)
        {
            var itemToSave = (TItem)itemObject;
            if (itemToSave.Id == 0)
            {
                await DataService.AddAsync(itemToSave);
            }
            else
            {
                await DataService.UpdateAsync(itemToSave);
            }
        }
        foreach (var id in changeSet.ItemsToDelete)
        {
            await DataService.DeleteAsync((int)id);
        }
        changeSet.Clear();
        NavigateBack();
    }

    private void HandleCancelAll()
    {
        ChangeSetService.GetChangeSetForUser(_userId).Clear();
        NavigateBack();
    }
}
