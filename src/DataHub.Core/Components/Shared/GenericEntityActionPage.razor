
@using DataHub.Core.Services.Generic
@using DataHub.Core.Models.Interfaces
@using DataHub.Core.Services
@using DataHub.Core.Models
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims

@typeparam TItem where TItem : class, ICloneable, IAuditableEntity

@inject NavigationManager NavigationManager
@inject NavigationContextService NavContext
@inject ChangeSetService ChangeSetService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject ILogger<GenericEntityActionPage<TItem>> Logger
@inject IJSRuntime JSRuntime

<div @onkeydown="HandleKeyDown">
    <h3>@Title</h3>

    @if (_isNavigating)
    {
        <div class="record-navigator">
            <FluentButton OnClick="NavigateToPrevious" Disabled="!_canNavigatePrevious">&lt; Previous</FluentButton>
            <span>Record @(_currentIndex + 1) of @_totalCount</span>
            <FluentButton OnClick="NavigateToNext" Disabled="!_canNavigateNext">Next &gt;</FluentButton>
        </div>
    }

    @if (item == null && !isLoading)
    {
        <p class="text-danger"><em>Item with ID @Id not found.</em></p>
        <button class="btn btn-secondary" @onclick="NavigateBack">Back to List</button>
    }
    else if (isLoading)
    {
        <p><em>Loading...</em></p>
    }
    else if (item != null)
    {
        <EditForm Model="@item" OnValidSubmit="HandleFormSubmit">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <fieldset disabled="@isReadOnly">
                @EditorTemplate(item)
            </fieldset>

            <div class="mt-3">
                @if (NavContext.Mode == RecordInteractionMode.Edit)
                {
                    <FluentButton Type="ButtonType.Submit" Appearance="Appearance.Accent">Save</FluentButton>
                }
                @if (NavContext.Mode == RecordInteractionMode.Copy)
                {
                    <FluentButton Type="ButtonType.Button" Appearance="Appearance.Accent" OnClick="HandleCopy">Copy</FluentButton>
                }
                @if (NavContext.Mode == RecordInteractionMode.Delete)
                {
                    <FluentButton Type="ButtonType.Button" Appearance="Appearance.Accent" OnClick="HandleDelete">Delete</FluentButton>
                }
                <FluentButton Type="ButtonType.Button" OnClick="Cancel">Cancel</FluentButton>
            </div>

            <div class="mt-3">
                @if (NavContext.Mode == RecordInteractionMode.Edit)
                {
                    <FluentButton Appearance="Appearance.Accent" OnClick="HandleSaveAll" Disabled="!_hasPendingChanges">Save All (@_pendingChangesCount)</FluentButton>
                    <FluentButton Appearance="Appearance.Neutral" OnClick="HandleCancelAll" Disabled="!_hasPendingChanges">Cancel All</FluentButton>
                }
                @if (NavContext.Mode == RecordInteractionMode.Copy)
                {
                    <FluentButton Appearance="Appearance.Accent" OnClick="HandleCopyAll">Copy All (@NavContext.NavigableRecordIds.Count)</FluentButton>
                }
                @if (NavContext.Mode == RecordInteractionMode.Delete)
                {
                    <FluentButton Appearance="Appearance.Accent" OnClick="HandleDeleteAll">Delete All (@NavContext.NavigableRecordIds.Count)</FluentButton>
                }
            </div>
        </EditForm>

        @if (_isNavigating)
        {
            <div class="record-navigator mt-3">
                <FluentButton OnClick="NavigateToFirst" Disabled="!_canNavigatePrevious">&lt;&lt; First</FluentButton>
                <FluentButton OnClick="NavigateToPrevious" Disabled="!_canNavigatePrevious">&lt; Previous</FluentButton>
                <span>Record @(_currentIndex + 1) of @_totalCount</span>
                <FluentButton OnClick="NavigateToNext" Disabled="!_canNavigateNext">Next &gt;</FluentButton>
                <FluentButton OnClick="NavigateToLast" Disabled="!_canNavigateNext">Last &gt;&gt;</FluentButton>
            </div>
        }
    }
</div>

@code {
    [Parameter]
    public int? Id { get; set; }

    [Parameter]
    public IDataService<TItem> DataService { get; set; } = default!;

    [Parameter]
    public RenderFragment<TItem> EditorTemplate { get; set; } = default!;

    [Parameter]
    public string EntityName { get; set; } = "Item";

    [Parameter]
    public string ListPagePath { get; set; } = "/";

    private TItem item = default!;
    private bool isLoading = true;
    private bool isReadOnly = false;
    private string _userId = "";

    private bool _isNavigating => NavContext.NavigableRecordIds.Count > 1;
    private bool _canNavigatePrevious => _currentIndex > 0;
    private bool _canNavigateNext => _currentIndex < _totalCount - 1;
    private int _currentIndex = -1;
    private int _totalCount = 0;

    private bool _hasPendingChanges => ChangeSetService.GetChangeSetForUser(_userId).HasChanges;
    private int _pendingChangesCount => ChangeSetService.GetChangeSetForUser(_userId).UpdatedItems.Count + ChangeSetService.GetChangeSetForUser(_userId).ItemsToDelete.Count;

    private bool isNew = false;

    private string Title
    {
        get
        {
            if (isNew) return $"New {EntityName}";
            return NavContext.Mode switch
            {
                RecordInteractionMode.Edit => $"Edit {EntityName}",
                RecordInteractionMode.View => $"View {EntityName}",
                RecordInteractionMode.Copy => $"Copy {EntityName}",
                RecordInteractionMode.Delete => $"Delete {EntityName}",
                _ => EntityName
            };
        }
    }

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;
        isNew = Id == null || Id == 0;
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        _userId = authState.User.FindFirstValue(ClaimTypes.NameIdentifier) ?? "SYSTEM";

        isReadOnly = NavContext.Mode == RecordInteractionMode.View || NavContext.Mode == RecordInteractionMode.Delete;

        if (_isNavigating)
        {
            _totalCount = NavContext.NavigableRecordIds.Count;
            _currentIndex = NavContext.NavigableRecordIds.IndexOf(Id.Value);
        }

        var changeSet = ChangeSetService.GetChangeSetForUser(_userId);
        if (Id.HasValue && changeSet.UpdatedItems.TryGetValue(Id.Value, out var changedItemObject))
        {
            item = (TItem)changedItemObject;
        }
        else if (!isNew)
        {
            var originalItem = await DataService.GetByIdAsync(Id.Value);
            if (originalItem != null)
            {
                item = (TItem)originalItem.Clone();
            }
        }
        else
        {
            item = Activator.CreateInstance<TItem>();
        }

        isLoading = false;
    }

    private async Task HandleFormSubmit()
    {
        var changeSet = ChangeSetService.GetChangeSetForUser(_userId);
        changeSet.AddOrUpdateItem(item.Id, item);
        Logger.LogInformation("Item {Id} saved to changeset.", item.Id);
        if (!_isNavigating)
        {
            await HandleSaveAll();
        }
    }

    private void Cancel()
    {
        if (Id.HasValue) {
            ChangeSetService.GetChangeSetForUser(_userId).RemoveFromChangeSet(Id.Value);
        }
        NavigateBack();
    }

    private void NavigateBack()
    {
        NavContext.ClearNavigationContext();
        NavigationManager.NavigateTo(ListPagePath);
    }

    private void HandleKeyDown(KeyboardEventArgs e)
    {
        if (_isNavigating)
        {
            if (e.Key == "PageDown") NavigateToNext();
            if (e.Key == "PageUp") NavigateToPrevious();
        }
    }

    private void NavigateToFirst()
    {
        if (_isNavigating)
        {
            var firstId = NavContext.NavigableRecordIds[0];
            NavigationManager.NavigateTo($"{NavContext.BasePath}/{firstId}", forceLoad: true);
        }
    }

    private void NavigateToLast()
    {
        if (_isNavigating)
        {
            var lastId = NavContext.NavigableRecordIds[^1];
            NavigationManager.NavigateTo($"{NavContext.BasePath}/{lastId}", forceLoad: true);
        }
    }

    private void NavigateToNext()
    {
        if (_canNavigateNext)
        {
            var nextId = NavContext.NavigableRecordIds[_currentIndex + 1];
            NavigationManager.NavigateTo($"{NavContext.BasePath}/{nextId}", forceLoad: true);
        }
    }

    private void NavigateToPrevious()
    {
        if (_canNavigatePrevious)
        {
            var prevId = NavContext.NavigableRecordIds[_currentIndex - 1];
            NavigationManager.NavigateTo($"{NavContext.BasePath}/{prevId}", forceLoad: true);
        }
    }

    private async Task HandleDelete()
    {
        if (item == null) return;
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", $"Are you sure you want to delete this item?");
        if (confirmed)
        {
            await DataService.DeleteAsync(item.Id);
            NavigateBack();
        }
    }

    private async Task HandleDeleteAll()
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", $"Are you sure you want to delete all {NavContext.NavigableRecordIds.Count} selected items?");
        if (confirmed)
        {
            foreach (var id in NavContext.NavigableRecordIds)
            {
                await DataService.DeleteAsync((int)id);
            }
            NavigateBack();
        }
    }

    private async Task HandleCopy()
    {
        if (item == null) return;
        item.Id = 0;
        await DataService.AddAsync(item);
        NavigateBack();
    }

    private async Task HandleCopyAll()
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", $"Are you sure you want to copy all {NavContext.NavigableRecordIds.Count} selected items?");
        if (confirmed)
        {
            foreach (var id in NavContext.NavigableRecordIds)
            {
                var originalItem = await DataService.GetByIdAsync((int)id);
                if (originalItem != null)
                {
                    var newItem = (TItem)originalItem.Clone();
                    newItem.Id = 0;
                    await DataService.AddAsync(newItem);
                }
            }
            NavigateBack();
        }
    }

    private async Task HandleSaveAll()
    {
        var changeSet = ChangeSetService.GetChangeSetForUser(_userId);
        foreach (var itemObject in changeSet.UpdatedItems.Values)
        {
            var itemToSave = (TItem)itemObject;
            if (itemToSave.Id == 0)
            {
                await DataService.AddAsync(itemToSave);
            }
            else
            {
                await DataService.UpdateAsync(itemToSave);
            }
        }
        foreach (var id in changeSet.ItemsToDelete)
        {
            await DataService.DeleteAsync((int)id);
        }
        changeSet.Clear();
        NavigateBack();
    }

    private void HandleCancelAll()
    {
        ChangeSetService.GetChangeSetForUser(_userId).Clear();
        NavigateBack();
    }
}
