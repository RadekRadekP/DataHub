@* GenericDataView.razor (Checkbox Version - Corrected) *@
@namespace DataHub.Core.Components.Shared
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Web
@using DataHub.Core.Models.DataGrid
@using DataHub.Core.Models.UI
@using DataHub.Core.Services
@using Microsoft.FluentUI.AspNetCore.Components
@using Microsoft.FluentUI.AspNetCore.Components.DataGrid
@using static Microsoft.FluentUI.AspNetCore.Components.Appearance
@using Microsoft.Extensions.Logging

@typeparam TItem where TItem : class

<div @ref="_container" class="generic-data-view" @onkeydown="HandleGridKeyDown" @onkeydown:preventDefault="_preventDefault" tabindex="0">
    <FluentDataGrid @ref="fluentDataGrid" ItemsProvider="@ProvideItems" ResizableColumns="true" TGridItem="TItem"
                        GridTemplateColumns="@GridTemplateColumns" Pagination="@_paginationState" Key="@_refreshKey" @bind-CurrentItem="_currentlyFocusedItem">
            @if (ShowCheckboxes)
            {
                <TemplateColumn>
                    <HeaderCellTitleTemplate>
                        <FluentCheckbox Label="Select all" Value="_areAllOnPageSelected" ValueChanged="OnSelectAllChanged" />
                    </HeaderCellTitleTemplate>
                    <ChildContent Context="item">
                        <FluentCheckbox Value="@SelectedItems.Contains(item)" ValueChanged="(newValue) => OnItemCheckedChanged(newValue, item)" />
                    </ChildContent>
                </TemplateColumn>
            }

            @foreach (var column in ColumnDefinitions)
            {
                <TemplateColumn Sortable="false">
                    <ColumnOptions>
                        <FluentCheckbox Label="Visible" @bind-Value="@column.IsVisible" />
                    </ColumnOptions>
                    <HeaderCellTitleTemplate>
                        <span style="cursor: pointer;">
                            @column.DisplayName
                        </span>
                    </HeaderCellTitleTemplate>
                    <ChildContent Context="item">
                        @if (column.GetValue != null)
                        {
                            @(column.GetValue.Compile().Invoke(item)?.ToString())
                        }
                    </ChildContent>
                </TemplateColumn>
            }

            @if (ActionColumnTemplate != null)
            {
                <TemplateColumn Title="Actions" Align="Align.End">
                    <ChildContent Context="item">
                        @ActionColumnTemplate(item)
                    </ChildContent>
                </TemplateColumn>
            }
        </FluentDataGrid>

        <div class="app-pagination-controls">
            <div class="record-info">Záznamů: @_paginationState.TotalItemCount</div>
            <FluentPaginator State="@_paginationState" TotalItems="@_paginationState.TotalItemCount" ItemsPerPage="@PageSize" />
            <div class="export-buttons">
                <FluentButton Appearance="@Appearance.Accent" @onclick="HandleExportToExcel">Excel</FluentButton>
            </div>
        </div>
</div>

<script>
    window.downloadFileFromStream = async (fileName, contentStreamReference) => {
        const arrayBuffer = await contentStreamReference.arrayBuffer();
        const blob = new Blob([arrayBuffer]);
        const url = URL.createObjectURL(blob);
        const anchorElement = document.createElement('a');
        anchorElement.href = url;
        anchorElement.download = fileName ?? '';
        anchorElement.click();
        anchorElement.remove();
        URL.revokeObjectURL(url);
    }
</script>

@code {
    [Parameter] public Func<DataRequestBase, Task<DataResult<TItem>>> DataProvider { get; set; } = default!;
    [Parameter] public Func<DataRequestBase, Task<Stream>> ExportFunction { get; set; } = default!;
    [Parameter] public int PageSize { get; set; } = 10;
    [Parameter] public List<ColumnDefinition<TItem>> ColumnDefinitions { get; set; } = new();
    [Parameter] public List<FilterCriterion> CurrentFilters { get; set; } = new();
    [Parameter] public string ExportFileName { get; set; } = "exceldata";
    [Parameter] public bool ShowCheckboxes { get; set; } = false;
    [Parameter] public RenderFragment<TItem>? ActionColumnTemplate { get; set; }
    [Parameter] public HashSet<TItem> SelectedItems { get; set; } = new();
    [Parameter] public EventCallback<HashSet<TItem>> SelectedItemsChanged { get; set; }

    [Inject] private ILogger<GenericDataView<TItem>> Logger { get; set; } = default!;
    [Inject] private IJSRuntime JSRuntime { get; set; } = default!;

    private ElementReference _container;
    private PaginationState _paginationState = new PaginationState();
    private int _refreshKey = 0;
    private FluentDataGrid<TItem> fluentDataGrid = default!;
    private TItem? _currentlyFocusedItem;
    private List<TItem> _itemsOnCurrentPage = new();
    private bool _preventDefault = false;

    private bool _areAllOnPageSelected
    {
        get => _itemsOnCurrentPage.Any() && _itemsOnCurrentPage.All(i => SelectedItems.Contains(i));
        set { /* This setter is intentionally left empty because the logic is handled in OnSelectAllChanged */ }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await _container.FocusAsync();
        }
    }

    private async Task HandleGridKeyDown(KeyboardEventArgs e)
    {
        _preventDefault = false;
        Logger.LogInformation("HandleGridKeyDown fired with key: {Key}", e.Key);

        switch (e.Key)
        {
            case " ": // Spacebar
            case "Enter":
                if (_currentlyFocusedItem != null)
                {
                    _preventDefault = true;
                    await OnItemCheckedChanged(!SelectedItems.Contains(_currentlyFocusedItem), _currentlyFocusedItem);
                }
                break;
            case "PageDown":
                _preventDefault = true;
                await HandlePageDownKey();
                break;
            case "PageUp":
                _preventDefault = true;
                await HandlePageUpKey();
                break;
        }
    }

    private async Task OnItemCheckedChanged(bool isChecked, TItem item)
    {
        if (isChecked)
        {
            SelectedItems.Add(item);
        }
        else
        {
            SelectedItems.Remove(item);
        }
        await SelectedItemsChanged.InvokeAsync(SelectedItems);
    }

    private void OnSelectAllChanged(bool newValue)
    {
        if (newValue)
        {
            foreach (var item in _itemsOnCurrentPage) SelectedItems.Add(item);
        }
        else
        {
            foreach (var item in _itemsOnCurrentPage) SelectedItems.Remove(item);
        }
        SelectedItemsChanged.InvokeAsync(SelectedItems);
    }

    private string GridTemplateColumns
    {
        get
        {
            var templates = new List<string>();
            if (ShowCheckboxes)
            {
                templates.Add("60px");
            }
            templates.AddRange(ColumnDefinitions.Where(c => c.IsVisible).Select(c => "1fr"));
            if (ActionColumnTemplate != null)
            {
                templates.Add("auto");
            }
            return string.Join(" ", templates);
        }
    }

    private async ValueTask<GridItemsProviderResult<TItem>> ProvideItems(GridItemsProviderRequest<TItem> request)
    {
        var dataRequest = new ServerDataRequest
        {
            Page = (request.StartIndex / request.Count.GetValueOrDefault(PageSize)) + 1,
            PageSize = request.Count.GetValueOrDefault(PageSize),
            Criteria = CurrentFilters
        };

        var result = await DataProvider.Invoke(dataRequest);
        _itemsOnCurrentPage = result.Data.ToList();

        Logger.LogInformation("GenericDataView: Providing {Count} items to FluentDataGrid. TotalCount: {TotalCount}.", result.Data.Count(), result.TotalCount);
        return GridItemsProviderResult.From(_itemsOnCurrentPage, result.TotalCount);
    }

    public async Task RefreshDataAsync()
    {
        _refreshKey++;
        if (fluentDataGrid != null)
        {
            await fluentDataGrid.RefreshDataAsync();
        }
        else
        {
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task HandleExportToExcel()
    {
        if (ExportFunction == null)
        {
            Logger.LogWarning("ExportFunction is not set. Cannot export to Excel.");
            return;
        }

        var request = new ServerDataRequest
        {
            Page = 1,
            PageSize = _paginationState.TotalItemCount ?? 0,
            Criteria = CurrentFilters
        };

        var excelStream = await ExportFunction.Invoke(request);
        using var streamRef = new DotNetStreamReference(excelStream);
        await JSRuntime.InvokeVoidAsync("downloadFileFromStream", $"{ExportFileName}.xlsx", streamRef);
        Logger.LogInformation("Export to Excel initiated.");
    }

    private async Task HandlePageDownKey()
    {
        if (_paginationState.CurrentPageIndex < (_paginationState.TotalItemCount / _paginationState.ItemsPerPage) - 1)
        {
            await _paginationState.SetCurrentPageIndexAsync(_paginationState.CurrentPageIndex + 1);
            await RefreshDataAsync();
        }
    }

    private async Task HandlePageUpKey()
    {
        if (_paginationState.CurrentPageIndex > 0)
        {
            await _paginationState.SetCurrentPageIndexAsync(_paginationState.CurrentPageIndex - 1);
            await RefreshDataAsync();
        }
    }
}
