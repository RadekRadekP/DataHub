@using RPK_BlazorApp.Models
@using Microsoft.FluentUI.AspNetCore.Components
@using RPK_BlazorApp.Models.UI
@using RPK_BlazorApp.Services
@using RPK_BlazorApp.Models.DataGrid

@typeparam TItem where TItem : class

@if (Visible)
{
    <div @ref="draggableContainer" class="floating-query-builder" style="top: 150px; left: 150px;">
        <div @ref="draggableHeader" class="floating-header">
            <div class="header-top-row">
                <span>Query Builder</span>
                <button class="close-button" @onclick="Close">&times;</button>
            </div>
            <div class="header-controls-row">
                <FluentTextField @ref="queryNameField" @bind-Value="QueryNameValue" Placeholder="Query Name" Label="Query Name" Class="query-name-input" />
                <div class="saved-queries-horizontal-list">
                    <strong>Saved:</strong>
                    <div class="list-container-horizontal">
                        @foreach (var query in SavedQueries)
                        {
                            <FluentButton Appearance="Appearance.Lightweight" @onclick="() => LoadQuery(query)" Class="saved-query-button">
                                @query.CriteriaName
                            </FluentButton>
                        }
                    </div>
                </div>
                <div class="button-group-header">
                    <FluentButton Appearance="Appearance.Accent" @onclick="InvokeSave">Save</FluentButton>
                    <FluentButton Appearance="Appearance.Neutral" @onclick="InvokeDelete">Delete</FluentButton>
                </div>
            </div>
        </div>

        <div class="floating-content">
            <div class="collapsible-section">
                <div class="expression-section">
                    <FluentTextArea style="width: 100%;" value="@QueryExpressionValue" @oninput="HandleQueryExpressionInput" Placeholder="Enter your query expression here..." Label="Expression" Rows="8" Resizable="true" Id="queryExpressionTextArea"></FluentTextArea>
                </div>
            </div>

            <div class="collapsible-section">
                <div class="fields-operators-section">
                    <div class="fields-list">
                            <h4>Columns</h4>
                            <div class="list-container scrollable-list">
                            @foreach (var column in AvailableColumns)
                            {
                                <div class="button-wrapper">
                                    <FluentButton Appearance="Appearance.Lightweight" @onclick="(() => InsertText(column.FieldName))">
                                        @column.FieldName
                                    </FluentButton>
                                </div>
                            }
                        </div>
                    </div>

                    <div class="operators-helpers-list">
                        <h4>Operators & Helpers</h4>
                        <div class="list-container">
                            @foreach (var item in OperatorsAndHelpers)
                            {
                                <div class="button-wrapper">
                                    <FluentButton Appearance="Appearance.Lightweight" @onclick="(() => InsertText(item))">
                                        @item
                                    </FluentButton>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="floating-footer">
            
            <FluentButton Appearance="Appearance.Accent" @onclick="ApplyCurrentQuery">Apply</FluentButton>
            <FluentButton Appearance="Appearance.Neutral" @onclick="ClearCurrentQuery">Clear</FluentButton>
            <FluentButton Appearance="Appearance.Neutral" @onclick="Close">Close</FluentButton>
        </div>
    </div>
}