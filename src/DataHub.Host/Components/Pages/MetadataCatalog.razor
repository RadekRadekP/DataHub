@page "/admin/metadata"
@using DataHub.Core.Services
@using DataHub.Platform.Services
@using DataHub.Platform.Data
@using Eisod.Services.Data
@using Grinding.Services.Data
@using Microsoft.EntityFrameworkCore
@using DataHub.Core.Models.Metadata
@using DataHub.Host.Components.Shared
@inject SchemaDiscoveryService DiscoveryService
@inject IDbContextFactory<EisodDbContext> EisodFactory
@inject IDbContextFactory<GrindingDbContext> GrindingFactory
@inject IDbContextFactory<ApplicationDbContext> AppFactory

<PageTitle>Metadata Catalog - DataHub</PageTitle>

<FluentStack Orientation="Orientation.Vertical" VerticalGap="16">
    
    <FluentCard>
        <FluentStack Orientation="Orientation.Vertical" VerticalGap="8">
            <h1 style="margin: 0;">üóÑÔ∏è Metadata Catalog Management</h1>
            <p style="color: var(--neutral-foreground-hint); margin: 0;">
                Central repository of all database tables, fields, and relationships. 
                Use this to automatically discover existing schemas and manage the catalog.
            </p>
        </FluentStack>
    </FluentCard>

    <FluentCard>
        <FluentStack Orientation="Orientation.Vertical" VerticalGap="16">
            <div>
                <h3 style="margin: 0 0 8px 0;">üîç Schema Discovery</h3>
                <p style="color: var(--neutral-foreground-hint); margin: 0;">
                    Scan your existing database contexts and automatically populate the catalog with metadata.
                    This process will discover tables, views, columns, data types, and relationships.
                </p>
            </div>
            
            <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="8">
                <FluentButton Appearance="Appearance.Accent" 
                             OnClick="DiscoverAllSchemas" 
                             Disabled="@_isDiscovering"
                             IconStart="@(new Icons.Regular.Size20.DatabaseSearch())">
                    @if (_isDiscovering)
                    {
                        <text>Discovering Schemas...</text>
                    }
                    else
                    {
                        <text>Discover All Schemas</text>
                    }
                </FluentButton>

                @if (_discoveredEntities.Any())
                {
                    <FluentButton Appearance="Appearance.Outline" 
                                 OnClick="RefreshView"
                                 IconStart="@(new Icons.Regular.Size20.ArrowSync())">
                        Refresh View
                    </FluentButton>
                }
            </FluentStack>

            @if (_isDiscovering)
            {
                <FluentProgressRing />
            }
        </FluentStack>
    </FluentCard>

    @if (!string.IsNullOrEmpty(_discoveryMessage))
    {
        <FluentMessageBar Intent="@_messageIntent" Style="white-space: pre-line;">
            @_discoveryMessage
        </FluentMessageBar>
    }

    @if (_discoveredEntities.Any())
    {
        <FluentCard>
            <FluentStack Orientation="Orientation.Vertical" VerticalGap="12">
                <FluentStack Orientation="Orientation.Horizontal" HorizontalAlignment="HorizontalAlignment.Start">
                    <h3 style="margin: 0;">üìã Discovered Entities</h3>
                    <FluentBadge Appearance="Appearance.Accent">@_discoveredEntities.Count</FluentBadge>
                </FluentStack>
                
                <FluentDataGrid Items="@_discoveredEntities.AsQueryable()" 
                               ResizableColumns="true"
                               GridTemplateColumns="0.8fr 1fr 1fr 0.5fr 0.5fr 0.5fr 0.5fr">
                    <PropertyColumn Property="@(e => e.DbContextName)" Title="Context" Sortable="true" />
                    <PropertyColumn Property="@(e => e.EntityName)" Title="Entity" Sortable="true" />
                    <PropertyColumn Property="@(e => e.TableName)" Title="Table Name" Sortable="true" />
                    <PropertyColumn Property="@(e => e.SchemaName)" Title="Schema" Sortable="true" />
                    <TemplateColumn Title="Type">
                        <FluentBadge Appearance="@(context.IsView ? Appearance.Neutral : Appearance.Accent)">
                            @(context.IsView ? "View" : "Table")
                        </FluentBadge>
                    </TemplateColumn>
                    <TemplateColumn Title="Fields" Align="Align.Center">
                        <FluentBadge Appearance="Appearance.Lightweight">@context.FieldCount</FluentBadge>
                    </TemplateColumn>
                    <TemplateColumn Title="Actions" Align="Align.End">
                        <FluentButton Appearance="Appearance.Lightweight"
                                     OnClick="@(() => ShowEntityFields(context.EntityId))"
                                     IconStart="@(new Icons.Regular.Size20.Eye())">
                            View Fields
                        </FluentButton>
                    </TemplateColumn>
                </FluentDataGrid>
            </FluentStack>
        </FluentCard>
        
        @* Field Details Panel *@
        @if (_selectedEntityFields != null)
        {
            <FluentCard>
                <FluentStack Orientation="Orientation.Vertical" VerticalGap="12">
                    <FluentStack Orientation="Orientation.Horizontal" HorizontalAlignment="HorizontalAlignment.Start">
                        <h3 style="margin: 0;">üîç Fields for: @_selectedEntityName</h3>
                        <FluentBadge Appearance="Appearance.Accent">@_selectedEntityFields.Count fields</FluentBadge>
                        <FluentButton Appearance="Appearance.Lightweight"
                                     OnClick="ClearFieldSelection"
                                     IconStart="@(new Icons.Regular.Size20.Dismiss())">
                            Close
                        </FluentButton>
                    </FluentStack>
                    
                    <FluentDataGrid Items="@_selectedEntityFields.AsQueryable()"
                                   ResizableColumns="true"
                                   GridTemplateColumns="1fr 1fr 0.8fr 0.8fr 0.4fr 0.4fr 0.4fr 0.4fr 0.5fr">
                        <PropertyColumn Property="@(f => f.FieldName)" Title="Field Name" Sortable="true" />
                        <PropertyColumn Property="@(f => f.DisplayName)" Title="Display Name" Sortable="true" />
                        <PropertyColumn Property="@(f => f.ClrType)" Title="CLR Type" Sortable="true" />
                        <PropertyColumn Property="@(f => f.SqlType)" Title="SQL Type" Sortable="true" />
                        <TemplateColumn Title="PK">
                            @if (context.IsPrimaryKey)
                            {
                                <FluentBadge Appearance="Appearance.Accent">üîë</FluentBadge>
                            }
                        </TemplateColumn>
                        <TemplateColumn Title="FK">
                            @if (context.IsForeignKey)
                            {
                                <FluentBadge Appearance="Appearance.Neutral">üîó</FluentBadge>
                            }
                        </TemplateColumn>
                        <TemplateColumn Title="Null">
                            @if (context.IsNullable)
                            {
                                <FluentBadge Appearance="Appearance.Neutral">‚úì</FluentBadge>
                            }
                        </TemplateColumn>
                        <TemplateColumn Title="Visible">
                            @if (context.IsVisibleInGrid)
                            {
                                <FluentBadge Appearance="Appearance.Accent">ÔøΩÔ∏è</FluentBadge>
                            }
                        </TemplateColumn>
                        <PropertyColumn Property="@(f => f.DisplayOrder)" Title="Order" Sortable="true" />
                    </FluentDataGrid>
                </FluentStack>
            </FluentCard>
        }
    }
    else if (!_isDiscovering && string.IsNullOrEmpty(_discoveryMessage))
    {
        <FluentCard>
            <FluentStack Orientation="Orientation.Vertical" VerticalGap="12" HorizontalAlignment="HorizontalAlignment.Center">
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 48px; margin-bottom: 16px;">üì≠</div>
                    <h3>No Entities Discovered Yet</h3>
                    <p style="color: var(--neutral-foreground-hint);">
                        Click "Discover All Schemas" to scan your database contexts and populate the catalog.
                    </p>
                </div>
            </FluentStack>
        </FluentCard>
    }

    @* Relations Section *@
    @if (_discoveredEntities.Any())
    {
        <FluentCard>
            <FluentStack Orientation="Orientation.Vertical" VerticalGap="12">
                <FluentStack Orientation="Orientation.Horizontal" HorizontalAlignment="HorizontalAlignment.Start">
                    <h3 style="margin: 0;">üîó Relations</h3>
                    <FluentBadge Appearance="Appearance.Accent">@_relations.Count</FluentBadge>
                </FluentStack>

                <FluentButton Appearance="Appearance.Accent"
                             OnClick="OpenCreateRelationDialog"
                             IconStart="@(new Icons.Regular.Size20.Add())">
                    Create New Relation
                </FluentButton>

                @if (_relations.Any())
                {
                    <FluentDataGrid Items="@_relations.AsQueryable()"
                                   ResizableColumns="true"
                                   GridTemplateColumns="1fr 1fr 1fr 1fr 0.8fr 0.5fr">
                        <PropertyColumn Property="@(r => r.FromEntity!.EntityName)" Title="From Entity" Sortable="true" />
                        <PropertyColumn Property="@(r => r.FromField!.FieldName)" Title="From Field" Sortable="true" />
                        <PropertyColumn Property="@(r => r.ToEntity!.EntityName)" Title="To Entity" Sortable="true" />
                        <PropertyColumn Property="@(r => r.DisplayField != null ? r.DisplayField.FieldName : r.ToField!.FieldName)" Title="Display Field" Sortable="true" />
                        <PropertyColumn Property="@(r => r.RelationType)" Title="Type" Sortable="true" />
                        <TemplateColumn Title="Actions">
                            <FluentButton Appearance="Appearance.Lightweight"
                                         OnClick="@(() => OpenEditRelationDialog(context))"
                                         IconStart="@(new Icons.Regular.Size20.Edit())">
                                Edit
                            </FluentButton>
                            <FluentButton Appearance="Appearance.Lightweight"
                                         OnClick="@(() => DeleteRelation(context.Id))"
                                         IconStart="@(new Icons.Regular.Size20.Delete())">
                                Delete
                            </FluentButton>
                        </TemplateColumn>
                    </FluentDataGrid>
                }
                else
                {
                    <div style="text-align: center; padding: 20px; color: var(--neutral-foreground-hint);">
                        No relations defined yet. Click "Create New Relation" to add one.
                    </div>
                }
            </FluentStack>
        </FluentCard>
    }

</FluentStack>

<RelationEditorDialog @bind-Hidden="_relationDialogHidden" 
                      EditRelation="_editingRelation"
                      OnSaved="OnRelationSaved" />

@code {
    private bool _isDiscovering = false;
    private string _discoveryMessage = string.Empty;
    private MessageIntent _messageIntent = MessageIntent.Info;
    private List<EntitySummary> _discoveredEntities = new();
    private List<MetaRelation> _relations = new();
    private bool _relationDialogHidden = true;
    private MetaRelation? _editingRelation = null;
    private List<FieldSummary>? _selectedEntityFields = null;
    private string _selectedEntityName = string.Empty;

    [Inject] private IMetadataService MetadataService { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        await RefreshView();
        await LoadRelations();
    }

    private async Task RefreshView()
    {
        using (var catalogContext = await AppFactory.CreateDbContextAsync())
        {
            _discoveredEntities = await catalogContext.MetaEntities
                .Select(e => new EntitySummary
                {
                    EntityId = e.Id,
                    DbContextName = e.DbContextName,
                    EntityName = e.EntityName,
                    TableName = e.TableName,
                    SchemaName = e.SchemaName,
                    IsView = e.IsView,
                    FieldCount = catalogContext.MetaFields.Count(f => f.MetaEntityId == e.Id)
                })
                .ToListAsync();
        }
        StateHasChanged();
    }

    private async Task ShowEntityFields(int entityId)
    {
        using (var catalogContext = await AppFactory.CreateDbContextAsync())
        {
            var entity = await catalogContext.MetaEntities.FindAsync(entityId);
            if (entity != null)
            {
                _selectedEntityName = entity.EntityName;
                _selectedEntityFields = await catalogContext.MetaFields
                    .Where(f => f.MetaEntityId == entityId)
                    .Select(f => new FieldSummary
                    {
                        FieldName = f.FieldName,
                        DisplayName = f.DisplayName,
                        ClrType = f.ClrType,
                        SqlType = f.SqlType,
                        IsNullable = f.IsNullable,
                        IsPrimaryKey = f.IsPrimaryKey,
                        IsForeignKey = f.IsForeignKey,
                        MaxLength = f.MaxLength,
                        IsVisibleInGrid = f.IsVisibleInGrid,
                        DisplayOrder = f.DisplayOrder
                    })
                    .OrderBy(f => f.DisplayOrder)
                    .ToListAsync();
            }
        }
        StateHasChanged();
    }

    private void ClearFieldSelection()
    {
        _selectedEntityFields = null;
        _selectedEntityName = string.Empty;
        StateHasChanged();
    }

    private async Task LoadRelations()
    {
        _relations = await MetadataService.GetAllRelationsAsync();
        StateHasChanged();
    }

    private async Task DiscoverAllSchemas()
    {
        _isDiscovering = true;
        _discoveryMessage = string.Empty;
        StateHasChanged();

        try
        {
            int totalEntities = 0;
            var messages = new List<string>();

            // Discover Eisod schema
            using (var eisodContext = await EisodFactory.CreateDbContextAsync())
            {
                var count = await DiscoveryService.DiscoverAndImportAsync(eisodContext, "EisodDbContext");
                totalEntities += count;
                messages.Add($"‚úÖ EisodDbContext: {count} entities");
            }

            // Discover Grinding schema
            using (var grindingContext = await GrindingFactory.CreateDbContextAsync())
            {
                var count = await DiscoveryService.DiscoverAndImportAsync(grindingContext, "GrindingDbContext");
                totalEntities += count;
                messages.Add($"‚úÖ GrindingDbContext: {count} entities");
            }

            // Register in-memory entities (DummyItem, DummyCategory, DummyStatus)
            var inMemoryCount = await DiscoveryService.RegisterInMemoryEntitiesAsync();
            totalEntities += inMemoryCount;
            messages.Add($"‚úÖ In-Memory Entities: {inMemoryCount} entities (DummyItem + lookups)");

            await RefreshView();
            await LoadRelations();

            messages.Add($"\nüéâ Discovery complete! Total: {totalEntities} entities discovered.");
            _discoveryMessage = string.Join("\n", messages);
            _messageIntent = MessageIntent.Success;
        }
        catch (Exception ex)
        {
            _discoveryMessage = $"‚ùå Error during discovery:\n{ex.Message}\n\nStack trace:\n{ex.StackTrace}";
            _messageIntent = MessageIntent.Error;
        }
        finally
        {
            _isDiscovering = false;
            StateHasChanged();
        }
    }

    private void OpenCreateRelationDialog()
    {
        _editingRelation = null;
        _relationDialogHidden = false;
        StateHasChanged();
    }

    private void OpenEditRelationDialog(MetaRelation relation)
    {
        _editingRelation = relation;
        _relationDialogHidden = false;
        StateHasChanged();
    }

    private async Task OnRelationSaved()
    {
        await LoadRelations();
        _discoveryMessage = "‚úÖ Relation saved successfully";
        _messageIntent = MessageIntent.Success;
        StateHasChanged();
    }

    private async Task DeleteRelation(int relationId)
    {
        try
        {
            await MetadataService.DeleteRelationAsync(relationId);
            await LoadRelations();
            _discoveryMessage = "‚úÖ Relation deleted successfully";
            _messageIntent = MessageIntent.Success;
        }
        catch (Exception ex)
        {
            _discoveryMessage = $"‚ùå Error deleting relation: {ex.Message}";
            _messageIntent = MessageIntent.Error;
        }
        StateHasChanged();
    }

    private class EntitySummary
    {
        public int EntityId { get; set; }
        public string DbContextName { get; set; } = string.Empty;
        public string EntityName { get; set; } = string.Empty;
        public string TableName { get; set; } = string.Empty;
        public string SchemaName { get; set; } = string.Empty;
        public bool IsView { get; set; }
        public int FieldCount { get; set; }
    }

    private class FieldSummary
    {
        public string FieldName { get; set; } = string.Empty;
        public string DisplayName { get; set; } = string.Empty;
        public string ClrType { get; set; } = string.Empty;
        public string SqlType { get; set; } = string.Empty;
        public bool IsNullable { get; set; }
        public bool IsPrimaryKey { get; set; }
        public bool IsForeignKey { get; set; }
        public int? MaxLength { get; set; }
        public bool IsVisibleInGrid { get; set; }
        public int DisplayOrder { get; set; }
    }
}
